# -----------------------------------------------------
# 1. 패키지 업데이트
# -----------------------------------------------------
- name: "APT update"
  apt:
    update_cache: yes
    cache_valid_time: 3600

# -----------------------------------------------------
# 2. Docker 설치에 필요한 패키지 설치 (keyrings 방식)
# -----------------------------------------------------
- name: "Install required packages for Docker"
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - software-properties-common
    state: present

# -----------------------------------------------------
# 3. keyrings 디렉토리 생성
# -----------------------------------------------------
- name: "Create /etc/apt/keyrings directory"
  file:
    path: /etc/apt/keyrings
    state: directory
    owner: root
    group: root
    mode: '0755'

# -----------------------------------------------------
# 4. Docker GPG 키 추가 (keyrings)
# -----------------------------------------------------
- name: "Add Docker GPG key"
  shell: |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
    | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg

# -----------------------------------------------------
# 5. Docker 공식 APT 저장소 추가
# -----------------------------------------------------
- name: "Add Docker APT repository"
  copy:
    dest: /etc/apt/sources.list.d/docker.list
    owner: root
    group: root
    mode: '0644'
    content: |
      deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable

# -----------------------------------------------------
# 6. Docker 저장소 반영
# -----------------------------------------------------
- name: "APT update after Docker repo added"
  apt:
    update_cache: yes

# -----------------------------------------------------
# 7. Docker Engine 설치
# -----------------------------------------------------
- name: "Install Docker Engine"
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
    state: present

# -----------------------------------------------------
# 8. Docker data-root 디렉토리 생성
# -----------------------------------------------------
- name: "Create Docker data-root directory"
  file:
    path: "{{ docker_data_root }}"
    state: directory
    owner: root
    group: root
    mode: '0711'

# -----------------------------------------------------
# 9-1. Docker daemon.json 설정
# -----------------------------------------------------
- name: "Create /etc/docker directory exists"
  file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: '0755'

# -----------------------------------------------------
# 9-2. Docker daemon.json 설정
# -----------------------------------------------------
- name: "Configure Docker daemon.json"
  copy:
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: '0644'
    content: |
      {
        "data-root": "{{ docker_data_root }}"
      }
  notify: Restart Docker

# -----------------------------------------------------
# 10. Docker 서비스 활성화 및 실행
# -----------------------------------------------------
- name: "Enable and start Docker service"
  systemd:
    name: docker
    enabled: yes
    state: started

# -----------------------------------------------------
# 11. Docker 실행 상태 검증
# -----------------------------------------------------
- name: "Check Docker service status"
  command: systemctl is-active docker
  register: docker_status
  changed_when: false

- name: "Assert Docker is running"
  assert:
    that:
      - docker_status.stdout == "active"
    success_msg: "Good!.. | Docker service is running"
    fail_msg: "ERROR!.. | Docker service is NOT running"
