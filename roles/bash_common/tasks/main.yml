# -----------------------------------------------------
# 시스템 공통 Bash 환경 설정
# -----------------------------------------------------

# 1. /etc/job_project.conf 생성
- name: "Create /etc/job_project.conf from inventory variables"
  copy:
    dest: /etc/job_project.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      {% for env in job_project_envs.split(';') %}
      export {{ env }}
      {% endfor %}

# -----------------------------------------------------
# 2. bashrc 에 공통 설정 적용
# -----------------------------------------------------
- name: "Apply common bash settings to system targets"
  blockinfile:
    path: "{{ item }}"
    marker: "# {mark} ANSIBLE COMMON BASH CONFIG"
    block: |
      # Load project environment variables
      if [ -f /etc/job_project.conf ]; then
          source /etc/job_project.conf
      fi

      # Safe aliases
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'

      # Prompt
      PS1='[\h:\w] '
    create: yes
  loop:
    - /root/.bashrc
    - /etc/skel/.bashrc

# -----------------------------------------------------
# 3. 검증
# -----------------------------------------------------
- name: "Verify job_project.conf exists"
  stat:
    path: /etc/job_project.conf
  register: job_conf

- name: "Verify bash common config applied"
  shell: grep -q "ANSIBLE COMMON BASH CONFIG" /root/.bashrc
  register: bash_check
  changed_when: false

- name: "Validation result"
  assert:
    that:
      - job_conf.stat.exists
      - bash_check.rc == 0
    success_msg: "Good!.. | Common bash environment is correctly applied"
    fail_msg: "ERROR!.. | Common bash environment is NOT applied"

